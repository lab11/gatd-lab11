<html>
<head>
	<script src="bower_components/socket.io-client/dist/socket.io.min.js"></script>
	<script src="bower_components/jquery/dist/jquery.min.js"></script>
	<script src="js/jquery.flot.custom-0.8.2.js"></script>
	<script src="bower_components/flot/jquery.flot.time.js"></script>
	<script src="bower_components/underscore/underscore.js"></script>
	<script src="js/jquery.grapher.js"></script>
	<script src="js/gatd_graph.js"></script>
	<script src="js/pretty.js"></script>
	<script>WEB_SOCKET_SWF_LOCATION='bower_components/socket.io-client/dist/WebSocketMain.swf'</script>

	<link href="css/gatd_graph.css" media="all" rel="stylesheet" type="text/css" />

	<title>Opo</title>
</head>

<body>
	<div id="headerBar">
		<div style="width:1000px; margin:0 auto; text-align:center;">
			<div style="float:left"><img src="images/BlockM-rball.png" height="50px" style="margin-top:5px;" /></div>
			<div style="float:left; padding:6px 0 0 350px;">Opo</div>
		</div>
	</div>
	<div id="body">
		<div>
			<canvas id="contact_canvas" width="1600" height="1120"
				style="z-index: 1; position:absolute; top:100px; right: 0; left: 0; margin-right: auto; margin-left: auto;"></canvas>
		</div>
	</div>

	<script>
	var OPO_PID = '4wbddZCSIj';
	var socket_loc;

	var WIDTH    = 1600;
	var PX_SCALE = 10;
	var ROWS     = 39;

	var HEADER_HEIGHT = 120;
	var HEADER_DOT_TOP_MARGIN = 75;
	var HEADER_NAME_TOP_MARGIN = 110;

	var BODY_HEIGHT = 1000;

	var COLUMN_LEFT_MARGIN = 150;
	var COLUMN_SPACING = 50;

	var ROW_TOP_MARGIN = 50;
	var ROW_SPACING = 25;

	var contact_canvas = document.getElementById('contact_canvas');

	contact_canvas.width  = WIDTH;
	contact_canvas.height = HEADER_HEIGHT + BODY_HEIGHT;

	var num_people = 0;
	var people = {};
	var columns = [];
	var ranges = [];
	var dedup = {};

	var loc_hist = Array();
	var age_out = 15000; //1000 * 60 * 5;

	function draw_line (context, x1, y1, x2, y2) {
		context.strokeStyle = '#ccc';
		context.fillStyle = '#ccc';
		context.beginPath();
		context.moveTo(x1, y1);
		context.lineTo(x2, y2);
		context.closePath();
		context.fill();
		context.stroke();
	}

	function draw_circle (context, x, y, color) {
		context.beginPath();
		context.arc(x, y, 10, 0, 2 * Math.PI);
		context.fillStyle = color;
		context.strokeStyle = color;
		context.fill();
		context.lineWidth = 2;
		context.stroke();
	}

	function draw_text (context, text, x, y, align) {
		context.textAlign = align;
		context.strokeStyle = '#000';
		context.fillStyle = '#000';
		context.fillText(text, x, y);
	}

	function draw_header (context) {

		// Clear header
		context.clearRect(0, 0, WIDTH, HEADER_HEIGHT);

		// Draw line to separate header
		draw_line(context, 0, HEADER_HEIGHT, WIDTH, HEADER_HEIGHT);

		// Draw header dots and names
		for (i=0; i<columns.length; i++) {
			pid = columns[i];
			x = COLUMN_LEFT_MARGIN + i*COLUMN_SPACING;
			y = HEADER_DOT_TOP_MARGIN;
			draw_circle(context, x, y, people[pid]['color']);

			draw_text(context, people[pid]['name'], x, HEADER_NAME_TOP_MARGIN, 'center');
		}
	}

	function addRangeEvent (data) {
		txid = data['tx_id'];
		rxid = data['last_tx_id'];
		trf  = data['t_rf'];

		if ('name' in data) name = data['name'];
		else name = txid;

		if ('color' in data) color = data['color'];
		else color = get_color(txid);


		if (!(txid in people)) {
			people[txid] = {};
			people[txid]['color'] = color;
			people[txid]['column'] = num_people;
			people[txid]['name'] = name;
			num_people++;
			columns.push(txid);
		} else {
			people[txid]['color'] = color;
			people[txid]['name'] = name;
		}

		if (!(rxid in people)) {
			people[rxid] = {};
			people[rxid]['color'] = get_color(rxid);
			people[rxid]['column'] = num_people;
			people[rxid]['name'] = rxid;
			num_people++;
			columns.push(rxid);
		}

		if ((txid + '' + rxid) in dedup) {
			if (dedup[txid + '' + rxid] == trf) return;
		}
		dedup[txid + '' + rxid] = trf;

		ranges.push([txid, rxid, new Date(data['time']), Math.round(data['range']*10)/10]);

		draw();
	}

	function nice_date (d) {
		return
	}



	function draw () {
		var context = contact_canvas.getContext('2d');

		draw_header(context);

		context.clearRect(0, HEADER_HEIGHT, WIDTH, BODY_HEIGHT);

		for (i=ranges.length-1; i>0 && i>ranges.length-ROWS; i--) {
			tx = ranges[i][0];
			rx = ranges[i][1];
			timestamp = ranges[i][2];
			range     = ranges[i][3];
			y = ROW_TOP_MARGIN + (ROW_SPACING*(ranges.length-i-1)) + HEADER_HEIGHT;
			x1 = people[tx]['column']*COLUMN_SPACING+COLUMN_LEFT_MARGIN;
			x2 = people[rx]['column']*COLUMN_SPACING+COLUMN_LEFT_MARGIN;

			draw_line(context, x1, y, x2, y);

			draw_circle(context, x1, y, people[tx]['color']);
			draw_circle(context, x2, y, people[rx]['color']);

			draw_text(context, prettyDate(timestamp), 10, y, 'left');
			draw_text(context, range, (x1+x2)/2, y-1, 'center');
		}
	}
/*
	function tx(x) {
		return x + WIDTH / 2;
	}

	function ty(y) {
		return HEIGHT/2 - y;
	}

	function t(pt) {
		return [tx(pt[0]), ty(pt[1])];
	}

	function draw_line(context, start, end) {
		context.beginPath();
		//console.log(start);
		//console.log(end);
		context.moveTo(start[0], start[1]);
		context.lineTo(end[0], end[1]);
		context.stroke();
	}

	// Adapted from http://jsfiddle.net/SguzM/89/
	function findAngle(p1, p2) {
		return Math.atan2((p2[1] - p1[1]), (p2[0] - p1[0]));
	}

	function drawArrowhead(ctx, locx, locy, angle, sizex, sizey, fill) {
		var hx = sizex / 2;
		var hy = sizey / 2;
		ctx.translate((locx ), (locy));
		ctx.rotate(angle);
		ctx.translate(-hx,-hy);

		if (fill) {
			ctx.beginPath();
			ctx.moveTo(0,0);
			ctx.lineTo(0,1*sizey);
			ctx.lineTo(1*sizex,1*hy);
			ctx.closePath();
			ctx.fill();
		} else {
			ctx.beginPath();
			ctx.moveTo(0,1*sizey);
			ctx.lineTo(1*sizex,1*hy);
			ctx.moveTo(0,0);
			ctx.lineTo(1*sizex,1*hy);
			ctx.stroke();
		}

		ctx.translate(hx,hy);
		ctx.rotate(-angle);
		ctx.translate(-locx,-locy);
	}

	function draw_arrow(context, start, end) {
		draw_line(context, start, end);
		angle = findAngle(start, end);
		//console.log("angle: " + angle);
		drawArrowhead(context, end[0], end[1], angle, 10, 10, false);
	}

	function draw_background() {
		var grid_canvas = document.getElementById('grid_canvas');
		var context = grid_canvas.getContext('2d');

		// Start with a blank slate
		context.clearRect(0, 0, WIDTH, HEIGHT);

		// Draw 1" grid
		context.strokeStyle = '#ccc';
		//context.setLineDash([2,3]);
		for (r in _.range(WIDTH/PX_SCALE + 1)) {
			i = r*PX_SCALE;
			context.beginPath();
			context.moveTo(0, i);
			context.lineTo(WIDTH, i);
			context.stroke();

			context.beginPath();
			context.moveTo(i, 0);
			context.lineTo(i, WIDTH);
			context.stroke();
		}

		// Draw orientation marker
		context.strokeStyle = "#00f";
		context.fillStyle = '#00f';
		context.textBaseline = "middle";

		draw_arrow(context, [PX_SCALE*1, PX_SCALE*1], [PX_SCALE*4, PX_SCALE*1]);
		draw_arrow(context, [PX_SCALE*1, PX_SCALE*1], [PX_SCALE*1, PX_SCALE*4]);
		context.fillText('+x', PX_SCALE*5, PX_SCALE*1);
		context.textAlign = 'center';
		context.fillText('+y', PX_SCALE*1, PX_SCALE*5);
		context.textAlign = 'left';

		// Draw 1" scale marker
		context.strokeStyle = "#f00";
		context.fillStyle = '#f00';
		context.textBaseline = "middle";

		draw_line(context, [PX_SCALE*7, PX_SCALE], [PX_SCALE*8, PX_SCALE]);
		draw_line(context, [PX_SCALE*7, PX_SCALE+PX_SCALE/3], [PX_SCALE*7,   PX_SCALE-PX_SCALE/3]);
		draw_line(context, [PX_SCALE*8, PX_SCALE+PX_SCALE/3], [PX_SCALE*8, PX_SCALE-PX_SCALE/3]);
		var orig_font = context.font;
		context.font = "bold 11px sans-serif";
		context.fillText('1 inch', PX_SCALE*9, PX_SCALE);
		context.font = orig_font;

		// Draw Door
		var hinge = [200+220+320, 200+30]
		context.strokeStyle = '#000';
		context.lineWidth = 2;
		draw_line(context, t(hinge), t([hinge[0], hinge[1]-320]));
		context.lineWidth = 1;
		context.strokeStyle = '#666';
		context.beginPath();
		context.arc(tx(hinge[0]), ty(hinge[1]), 320, 0.5*Math.PI, Math.PI);
		context.stroke();

		// Draw Wall
		context.strokeStyle = '#000';
		context.lineWidth = 3;
		draw_line(context, t([-WIDTH/2, 200+30]), t([hinge[0]-320, 200+30]));
		draw_line(context, t([hinge[0], 200+30]), t([WIDTH/2, 200+30]));
		context.lineWidth = 1;

		// Draw Transmitter Box
		function draw_square(context, center, radius) {
			for (var off=-radius; off<=radius; off += (2*radius)) {
				context.beginPath();
				context.moveTo(center[0]+off, center[1]+off);
				context.lineTo(center[0]-off, center[1]+off);
				context.stroke();
				context.beginPath();
				context.moveTo(center[0]+off, center[1]+off);
				context.lineTo(center[0]+off, center[1]-off);
				context.stroke();
			}
		}

		var ceiling_pegboard_radius = 160;
		var floor_pegboard_radius = 200;

		if (document.getElementById("cb_floor_pegboard").checked) {
			context.strokeStyle = '#000';
			draw_square(context, t([0, 0]), floor_pegboard_radius);
		}

		if (document.getElementById("cb_ceil_pegboard").checked) {
			context.strokeStyle = '#0dd';
			draw_square(context, t([0, 0]), ceiling_pegboard_radius);
		}

		// Draw Transmitters
		context.strokeStyle = "#00f";

		context.beginPath();
		context.arc(tx(0), ty(0), 15, 0, 2 * Math.PI, false);
		context.stroke();
		for (var x_off=-150; x_off<=150; x_off += 300) {
			for (var y_off=-140; y_off<=140; y_off += 280) {
				context.beginPath();
				context.arc(tx(x_off), ty(y_off), 14, 0, 2 * Math.PI, false);
				context.stroke();
			}
		}

		// Draw train track
		if (document.getElementById("cb_train_track").checked) {
			context.strokeStyle = "#080";

			context.beginPath();
			context.arc(tx(-43.5), ty(0), 117.5, Math.PI*.5, 1.5*Math.PI, false);
			context.stroke();
			context.beginPath();
			context.arc(tx(43.5), ty(0), 117.5, Math.PI*1.5, .5*Math.PI, false);
			context.stroke();

			context.beginPath();
			context.moveTo(tx(-43.5), ty(117.5));
			context.lineTo(tx(43.5), ty(117.5));
			context.stroke()
			context.beginPath();
			context.moveTo(tx(-43.5), ty(-117.5));
			context.lineTo(tx(43.5), ty(-117.5));
			context.stroke();
		}
	}

	draw_background();

	function draw_loc(context, loc, rot, age) {
		var x = tx((loc[0] / 2.54) * PX_SCALE)
		var y = ty((loc[1] / 2.54) * PX_SCALE)
		var z = loc[2];
		context.beginPath();
		//console.log('Drawing loc at (' + x + ',' + y + ')');
		context.arc(x, y, 5, 0, 2 * Math.PI, false);

		context.globalAlpha = Math.max(0, 1-(age / age_out));
		//console.log("alpha: " + context.globalAlpha);
		context.fillStyle = '#faa';
		context.strokeStyle = '#f44' //"#f66";
		context.fill();
		context.lineWidth = 2;
		context.stroke();

		context.strokeStyle = '#00f' //"#f66";
		context.lineWidth = 1.5;
		//context.beginPath();
		//context.moveTo(x, y)
		//console.log(rot);
		//var x_rot = rot[0][0] * 30;
		//var y_rot = rot[0][1] * 30;
		//console.log('x_rot ' + x_rot + ' y_rot ' + y_rot);
		//context.lineTo(x-x_rot, y+y_rot)
		var x_rot = rot[0][0] * 30;
		var y_rot = rot[0][1] * 30;
		draw_arrow(context, [x,y], [x+x_rot, y+y_rot]);
	}

	function draw_all_locs() {
		var dots_ctx = dots_canvas.getContext('2d');
		dots_ctx.clearRect(0, 0, WIDTH, HEIGHT);
		if (loc_hist.length == 0) return;

		while ((loc_hist[0]['display_rx_time'] + age_out) < Date.now()) {
			console.log('Aged out entry (now: ' + Date.now() + ' disp_rx_time: ' + loc_hist[0]['display_rx_time'] + ')');
			loc_hist.shift();
			if (loc_hist.length == 0) return;
		}
		for (var i=0; i < loc_hist.length; i++) {
			var loc = loc_hist[i]['rx_location'];
			var rot = loc_hist[i]['rx_rotation'];
			var age = Math.max(1, Date.now() - loc_hist[i]['display_rx_time']);
			draw_loc(dots_ctx, loc, rot, age);
		}
	}

	var updater_interval = setInterval(function(){draw_all_locs()}, 500);
*/
	onload = function() {
		socket_loc = io.connect('inductor.eecs.umich.edu:8082/stream');
		socket_loc.on('connect', function (data) {
			socket_loc.emit('query', {'profile_id':       OPO_PID,
		                              '_processor_count': 0
		                             });
		});

		socket_loc.on('data', function (data) {
			addRangeEvent(data);
		});
	}
/*
	function on_grid_cb_click() {
		draw_background();
	}

	function onclick_replay_train() {
		console.log('onclick_replay_train clicked');
		replay_sock = io.connect('inductor.eecs.umich.edu:8084/stream');
		replay_sock.on('connect', function (data) {
			//console.log('emitting replay query for ' + TRAIN_START_TIME_EDT_MS + ' to ' +
			//	TRAIN_END_TIME_EDT_MS)
			replay_sock.emit('query',
				{'profile_id': LOC_VLC_PID,
				//'time': {'$gt': 1394722810000, '$lt': 1394723067000},
				'time': {'$gt': 1394722889000, '$lt': 1394723066235},
				'_speedup': 5.0,
				}
			);
			console.log('query emitted');
				//'time': {'$gt': 1395178041000}, // known data point at 1395178041086
				// PAT 11 AM 'time': {'$gt': 1394722800000},
				// BRAD 'time': {'$gt': 1394723150000},
				//'time': {'$gt': TRAIN_START_TIME_EDT_MS, '$lt': TRAIN_END_TIME_EDT_MS},
		});

		replay_sock.on('data', function (data) {
			data['display_rx_time'] = Date.now();
			console.log('replay data point: ' + data + ' time: ' + data['time']);
			loc_hist.push(data);
		});
	}

	$('#cb_floor_pegboard').click(on_grid_cb_click);
	$('#cb_ceil_pegboard').click(on_grid_cb_click);
	$('#cb_train_track').click(on_grid_cb_click);*/
	</script>

</body>
</html>
