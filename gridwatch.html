<html>
<head>
	<script src="bower_components/leaflet/dist/leaflet.js"></script>
	<script src="bower_components/socket.io-client/dist/socket.io.min.js"></script>
	<script src="bower_components/jquery/dist/jquery.min.js"></script>

	<link href="css/gatd_graph.css" media="all" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="bower_components/leaflet/dist/leaflet.css" />

	<title>GridWatch</title>

	<style>
	.info {
		width: 1000px;
		margin: 15px auto 30px auto;
		padding: 20px;
	}
	</style>
</head>

<body>

	<div id="headerBar">
		<div style="width:1000px; margin:0 auto; text-align:center;">
			<div style="float:left"><img src="images/BlockM-rball.png" height="50px" style="margin-top:5px;" /></div>
			<div style="float:left; padding:6px 0 0 350px;">Grid Watch</div>
		</div>
	</div>

	<div id="map" class="graph">
	</div>

	<div class="box_shadow info">
		GridWatch is a system for monitoring the power grid using smartphones.
		The idea is that if a phone transitions from charging to not charging
		without moving that event may signal a power outage.
		<br />
		<span style="color:#00ff00">Green circles</span> represent power
		transitions with movement.<br />
		<span style="color:#ff0000">Red circles</span> represent power
		transitions without movement which may be power outages.
	</div>

	<script>
	// create a map in the "map" div, set the view to a given place and zoom
	var map;

	var GW_PID = 'HthZRrHnlC';
	var s;

	function get_popup (data) {
		var p = "Phone ID: " + data['phone_id'] + "<br />";
		if ('owner' in data) {
			p += "Owner: " + data['owner'] + "<br />";
		}
		if ('accuracy' in data && data['accuracy'] > -1) {
			p += "Accuracy: " + data['accuracy'] + " meters<br />";
		}
		return p;
	}

	onload = function() {
		map = L.map('map').setView([42.281389, -83.748333], 13);

		// add an OpenStreetMap tile layer
		L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
		    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);

		s = io.connect('inductor.eecs.umich.edu:8082/stream');
		s.on('connect', function (data) {
			s.emit('query', {'profile_id': GW_PID,
			                 'time': 1209600000}
			      );
		});

		s.on('data', function (data) {
			if ('power_on' in data) {
				if (!data['power_on']) {
					// Detected a possible power outage
					L.circle([data['latitude'], data['longitude']], 50, {
						color: 'red',
						fillColor: '#f03',
						fillOpacity: 0.5
					}).addTo(map).bindPopup(get_popup(data));

				} else {
					L.circle([data['latitude'], data['longitude']], 50, {
						color: 'green',
						fillColor: '#00ff00',
						fillOpacity: 0.5
					}).addTo(map).bindPopup(get_popup(data));
				}
			}
		});
	}


	</script>

</body>
</html>