<html>
<head>
	<script src="http://cdn.leafletjs.com/leaflet-0.7.1/leaflet.js"></script>
	<script src="js/socket.io-0.8.7.js"></script>
	<script src="js/jquery-1.10.2.min.js"></script>

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.1/leaflet.css" />
	<link href="css/gatd_graph.css" media="all" rel="stylesheet" type="text/css" />

	<title>GridWatch</title>

	<style>
	.info {
		width: 1000px;
		margin: 15px auto 30px auto;
		padding: 20px;
	}
	</style>
</head>

<body>

	<div id="headerBar">
		<div style="width:1000px; margin:0 auto; text-align:center;">
			<div style="float:left"><img src="images/BlockM-rball.png" height="50px" style="margin-top:5px;" /></div>
			<div style="float:left; padding:6px 0 0 350px;">Grid Watch</div>
		</div>
	</div>

	<div id="map" class="graph">
	</div>

	<div class="box_shadow info">
		GridWatch is a system for monitoring the power grid using smartphones.
		The idea is that if a phone transitions from charging to not charging
		without moving that event may signal a power outage.
		<br />
		<span style="color:#00ff00">Green circles</span> represent power
		transitions with movement.<br />
		<span style="color:#ff0000">Red circles</span> represent power
		transitions without movement which may be power outages.
	</div>

	<script>
	// create a map in the "map" div, set the view to a given place and zoom
	var map;

	var GW_PID = 'HthZRrHnlC';
	var s;

	onload = function() {
		map = L.map('map').setView([42.281389, -83.748333], 13);

		// add an OpenStreetMap tile layer
		L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
		    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);

		s = io.connect('inductor.eecs.umich.edu:8080/stream');
		s.on('connect', function (data) {
			s.emit('query', {'profile_id': GW_PID}
			      );
		});

		s.on('data', function (data) {
			if (data['event_type'] == "unplugged_still") {
				// Detected a possible power outage
				L.circle([data['latitude'], data['longitude']], 50, {
					color: 'red',
					fillColor: '#f03',
					fillOpacity: 0.5
				}).addTo(map).bindPopup(data['phone_id']);

			} else if (data['event_type'] == "unplugged_moved") {
				L.circle([data['latitude'], data['longitude']], 50, {
					color: 'green',
					fillColor: '#00ff00',
					fillOpacity: 0.5
				}).addTo(map).bindPopup(data['phone_id']);
			}
		});
	}


</script>

</body>
