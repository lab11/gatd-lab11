<html>
<head>
	<script src="bower_components/socket.io-client/dist/socket.io.min.js"></script>
	<script src="bower_components/jquery/dist/jquery.min.js"></script>
	<script src="js/jquery.flot.custom-0.8.2.js"></script>
	<script src="bower_components/flot/jquery.flot.time.js"></script>
	<script src="bower_components/underscore/underscore.js"></script>
	<script src="js/jquery.grapher.js"></script>
	<script src="js/gatd_graph.js"></script>
	<script src="js/gatd_canvas.js"></script>
	<script src="js/pretty.js"></script>
	<script>WEB_SOCKET_SWF_LOCATION='bower_components/socket.io-client/dist/WebSocketMain.swf'</script>

	<link href="css/gatd_graph.css" media="all" rel="stylesheet" type="text/css" />

	<title>Opo</title>
</head>

<body>
	<div id="headerBar">
		<div style="width:1000px; margin:0 auto; text-align:center;">
			<div style="float:left"><img src="images/BlockM-rball.png" height="50px" style="margin-top:5px;" /></div>
			<div style="float:left; padding:6px 0 0 350px;">Opo</div>
		</div>
	</div>
	<div id="body">
		<div>
			<canvas id="contact_canvas" width="1600" height="1120"
				style="z-index: 1; position:absolute; top:100px; right: 0; left: 0; margin-right: auto; margin-left: auto;"></canvas>
		</div>
	</div>

	<script>
	var OPO_PID = '4wbddZCSIj';
	var socket_loc;

	var WIDTH    = 1600;
	var PX_SCALE = 10;
	var ROWS     = 39;

	var HEADER_HEIGHT = 120;
	var HEADER_DOT_TOP_MARGIN = 75;
	var HEADER_NAME_TOP_MARGIN = 110;

	var BODY_HEIGHT = 1000;

	var COLUMN_LEFT_MARGIN = 150;
	var COLUMN_SPACING = 50;

	var ROW_TOP_MARGIN = 50;
	var ROW_SPACING = 25;

	var contact_canvas = document.getElementById('contact_canvas');

	contact_canvas.width  = WIDTH;
	contact_canvas.height = HEADER_HEIGHT + BODY_HEIGHT;

	var num_people = 0;
	var people = {};
	var columns = [];
	var ranges = [];
	var dedup = {};

	var loc_hist = Array();
	var age_out = 15000; //1000 * 60 * 5;

	function draw_text (context, text, x, y, align) {
		context.textAlign = align;
		context.strokeStyle = '#000';
		context.fillStyle = '#000';
		context.fillText(text, x, y);
	}

	function draw_gray_line(context, x1, y1, x2, y2) {
		context.strokeStyle = '#ccc';
		context.fillStyle = '#ccc';
		draw_solid_line(context, x1, y1, x2, y2);
	}

	function draw_header (context) {

		// Clear header
		context.clearRect(0, 0, WIDTH, HEADER_HEIGHT);

		// Draw line to separate header
		draw_gray_line(context, 0, HEADER_HEIGHT, WIDTH, HEADER_HEIGHT);

		// Draw header dots and names
		for (i=0; i<columns.length; i++) {
			pid = columns[i];
			x = COLUMN_LEFT_MARGIN + i*COLUMN_SPACING;
			y = HEADER_DOT_TOP_MARGIN;
			draw_circle(context, x, y, 10, people[pid]['color']);

			draw_text(context, people[pid]['name'], x, HEADER_NAME_TOP_MARGIN, 'center');
		}
	}

	function draw () {
		var context = contact_canvas.getContext('2d');

		draw_header(context);

		context.clearRect(0, HEADER_HEIGHT, WIDTH, BODY_HEIGHT);

		for (i=ranges.length-1; i>0 && i>ranges.length-ROWS; i--) {
			// tx = 'tx_id' key, which is the Opo that sent the
			// packet received by gatd. This packet is the last
			// range that was _received_ by this node, so the arrow
			// for visualization is drawn rx --> tx (x2 --> x1).
			tx = ranges[i][0];
			rx = ranges[i][1];
			timestamp = ranges[i][2];
			range     = ranges[i][3];
			y = ROW_TOP_MARGIN + (ROW_SPACING*(ranges.length-i-1)) + HEADER_HEIGHT;
			x1 = people[tx]['column']*COLUMN_SPACING+COLUMN_LEFT_MARGIN;
			x2 = people[rx]['column']*COLUMN_SPACING+COLUMN_LEFT_MARGIN;

			// 15 = radius of circle (10) + 1/2 arrowhead size (5)
			context.strokeStyle = '#ccc';
			context.fillStyle = '#ccc';
			if (x2 < x1) {
				// Arrow points left
				draw_arrow(context, [x2, y], [x1-15, y], true);
			} else {
				// Arrow points right
				draw_arrow(context, [x2, y], [x1+15, y], true);
			}

			draw_circle(context, x1, y, 10, people[tx]['color']);
			draw_circle(context, x2, y, 10, people[rx]['color']);

			draw_text(context, prettyDate(timestamp), 10, y, 'left');
			draw_text(context, range, (x1+x2)/2, y-1, 'center');
		}
	}

	function addRangeEvent (data) {
		rxid = data['last_tx_id'];
		txid = data['tx_id'];
		lseq = data['last_seq'];

		if ('name' in data) name = data['name'];
		else name = txid;

		if ('color' in data) color = data['color'];
		else color = get_color(txid);

		if (!(_.has(people, txid))) {
			people[txid] = {};
			people[txid]['color'] = color;
			people[txid]['column'] = num_people;
			people[txid]['name'] = name;
			num_people++;
			columns.push(txid);

		} else {
			people[txid]['color'] = color;
			people[txid]['name'] = name;
		}

		if (!(_.has(people, rxid))) {
			people[rxid] = {};
			people[rxid]['color'] = get_color(rxid);
			people[rxid]['column'] = num_people;
			people[rxid]['name'] = rxid;
			num_people++;
			columns.push(rxid);
		}

		if (_.has(dedup, (txid + '' + rxid))) {
			if (dedup[txid + '' + rxid] == lseq) return;
		}
		dedup[txid + '' + rxid] = lseq;
		ranges.push([txid, rxid, new Date(data['full_time']*1000), Math.round(data['range']*10)/10]);

		draw();
	}

	onload = function() {
		socket_loc = io.connect('inductor.eecs.umich.edu:8082/stream');
		socket_loc.on('connect', function (data) {
			socket_loc.emit('query', {'profile_id':       OPO_PID,
		                              '_processor_count': 0
		                             });
		});

		socket_loc.on('data', function (data) {
			addRangeEvent(data);
		});
	}

	</script>

</body>
</html>
